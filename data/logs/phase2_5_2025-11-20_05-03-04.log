2025-11-20 05:03:04,171 [INFO] [sae_analyzer] setup_logging:167 - Phase: 2.5, GPU: CPU
2025-11-20 05:03:04,171 [INFO] [phase8_1_threshold_calculator.threshold_calculator] setup_logging:167 - Phase: 8.1, GPU: CPU
2025-11-20 05:03:04,172 [INFO] [phase8_1_threshold_calculator.runner] setup_logging:167 - Phase: 8.1, GPU: CPU
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:676 - 
============================================================
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:677 - PHASE 8.1: PERCENTILE THRESHOLD CALCULATOR
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:678 - ============================================================
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:679 - Calculates percentile-based thresholds from Phase 3.6 hyperparameter dataset
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:680 - Thresholds will be used by Phase 8.3 for selective steering
2025-11-20 05:03:04,172 [INFO] [main] run_phase8_1:681 - 
2025-11-20 05:03:04,173 [INFO] [main] run_phase8_1:684 - 
============================================================
CONFIGURATION
============================================================

ACTIVATION Settings:
  activation_cleanup_after_batch: True
  activation_clear_cache_between_layers: True
  activation_hook_type: resid_post
  activation_layers: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]
  activation_max_cache_gb: 10.0
  activation_max_length: 2048
  activation_position: -1

AUTOSAVE Settings:
  autosave_frequency: 100
  autosave_keep_last: 3

CHECKPOINT Settings:
  checkpoint_dir: checkpoints
  checkpoint_frequency: 50

CONTINUE Settings:
  continue_on_error: True

DATASET Settings:
  dataset_dir: data/phase1_0
  dataset_end_idx: None
  dataset_name: Muennighoff/mbpp
  dataset_split: test
  dataset_start_idx: 0

ENABLE Settings:
  enable_timing_stats: True

EVALUATION Settings:
  evaluation_random_seed: 42

GC Settings:
  gc_collect_frequency: 50

LOG Settings:
  log_dir: data/logs

MAX Settings:
  max_gpu_memory_usage_gb: 30.0
  max_memory_usage_gb: 100.0
  max_retries: 3

MEMORY Settings:
  memory_cleanup_frequency: 100

MODEL Settings:
  model_device: None
  model_dtype: None
  model_max_new_tokens: 800
  model_name: google/gemma-2-2b
  model_temperature: 0.0
  model_trust_remote_code: True

ORTHOGONALIZATION Settings:
  orthogonalization_target_weights: [embed, attn_o, mlp_down]

PHASE0 Settings:
  phase0_1_output_dir: data/phase0_1
  phase0_output_dir: data/phase0

PHASE1 Settings:
  phase1_output_dir: data/phase1_0

PHASE2 Settings:
  phase2_10_output_dir: data/phase2_10
  phase2_15_output_dir: data/phase2_15
  phase2_2_output_dir: data/phase2_2
  phase2_5_output_dir: data/phase2_5
  phase2_output_dir: data/phase2

PHASE3 Settings:
  phase3_10_output_dir: data/phase3_10
  phase3_10_temperatures: [0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4]
  phase3_11_output_dir: data/phase3_11
  phase3_12_output_dir: data/phase3_12
  phase3_5_output_dir: data/phase3_5
  phase3_6_output_dir: data/phase3_6
  phase3_8_output_dir: data/phase3_8
  phase3_output_dir: data/phase3

PHASE4 Settings:
  phase4_10_min_activation_freq: 0.001
  phase4_10_n_features: 10
  phase4_10_output_dir: data/phase4_10
  phase4_10_separation_threshold: 0.01
  phase4_12_output_dir: data/phase4_12
  phase4_14_output_dir: data/phase4_14
  phase4_14_significance_level: 0.05
  phase4_5_correct_coefficients: [10.0, 20.0, 30.0, 40.0, 50.0, 60.0, 70.0, 80.0, 90.0, 100.0]
  phase4_5_experiment_mode: all
  phase4_5_incorrect_coefficients: [100.0, 200.0, 300.0, 400.0, 500.0, 600.0, 700.0, 800.0, 900.0, 1000.0]
  phase4_5_meaningful_effect_threshold: 5.0
  phase4_5_output_dir: data/phase4_5
  phase4_5_plateau_threshold: 2.0
  phase4_5_search_tolerance: 2.0
  phase4_6_experiment_mode: all
  phase4_6_output_dir: data/phase4_6
  phase4_6_tolerance: 1.0
  phase4_8_correct_coefficient: 29
  phase4_8_experiment_mode: all
  phase4_8_incorrect_coefficient: 287
  phase4_8_output_dir: data/phase4_8

PHASE5 Settings:
  phase5_3_output_dir: data/phase5_3
  phase5_6_output_dir: data/phase5_6
  phase5_9_output_dir: data/phase5_9
  phase5_9_significance_level: 0.05

PHASE6 Settings:
  phase6_3_output_dir: data/phase6_3

PHASE7 Settings:
  phase7_12_output_dir: data/phase7_12
  phase7_3_model_name: google/gemma-2-2b-it
  phase7_3_output_dir: data/phase7_3
  phase7_6_model_name: google/gemma-2-2b-it
  phase7_6_output_dir: data/phase7_6

PHASE8 Settings:
  **phase8_1_output_dir**: data/phase8_1
  phase8_2_output_dir: data/phase8_2
  phase8_3_output_dir: data/phase8_3
  phase8_3_percentile: 50.0
  phase8_3_use_percentile_threshold: True

PILE Settings:
  pile_filter_enabled: True
  pile_samples: 10000
  pile_threshold: 0.02

PROGRESS Settings:
  progress_log_frequency: 10

RETRY Settings:
  retry_backoff: 1.0

SAE Settings:
  sae_checkpoint_dir: data/phase2/sae_checkpoints
  sae_cleanup_after_layer: True
  sae_hook_component: resid_post
  sae_latent_threshold: 0.02
  sae_repo_id: google/gemma-scope-2b-pt-res
  sae_save_after_each_layer: True
  sae_sparsity: 71
  sae_use_memory_mapping: False
  sae_width: 16k

SHOW Settings:
  show_progress_bar: True

SPLIT Settings:
  split_n_strata: 10
  split_random_seed: 42
  split_ratio_tolerance: 0.02

T Settings:
  t_statistic_min_samples: 10

TEMPERATURE Settings:
  temperature_samples_per_temp: 3
  temperature_variation_temps: [0.0]

TIMEOUT Settings:
  timeout_per_record: 300.0

VERBOSE Settings:
  verbose: False

============================================================
2025-11-20 05:03:04,173 [INFO] [phase8_1_threshold_calculator.runner] run_phase_8_1:24 - Starting Phase 8.1: Percentile Threshold Calculator
2025-11-20 05:03:04,173 [INFO] [phase8_1_threshold_calculator.threshold_calculator] __init__:60 - Initializing Threshold Calculator
2025-11-20 05:03:04,173 [INFO] [phase8_1_threshold_calculator.threshold_calculator] __init__:61 - Device: cuda
2025-11-20 05:03:04,173 [INFO] [phase8_1_threshold_calculator.threshold_calculator] __init__:62 - Output directory: data/phase8_1
2025-11-20 05:03:04,174 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:71 - Loading dependencies...
2025-11-20 05:03:04,174 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:74 - Loading incorrect-predicting feature info from Phase 3.8...
2025-11-20 05:03:04,174 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:87 - Incorrect-predicting feature: Layer 19, Feature 5441
2025-11-20 05:03:04,175 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:88 - Phase 3.8 optimal threshold (reference): 15.5086
2025-11-20 05:03:04,175 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:91 - Loading Phase 3.6 hyperparameter dataset...
2025-11-20 05:03:04,195 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:110 - Loaded 97 samples from Phase 3.6
2025-11-20 05:03:04,196 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:120 - Activation directory: data/phase3_6/activations/task_activations
2025-11-20 05:03:04,196 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:123 - Loading SAE for Layer 19...
2025-11-20 05:03:04,196 [INFO] [sae_analyzer] load_gemma_scope_sae:47 - Loading GemmaScope SAE for layer 19
2025-11-20 05:03:04,196 [INFO] [sae_analyzer] load_gemma_scope_sae:61 - Loading from HuggingFace: google/gemma-scope-2b-pt-res/layer_19/width_16k/average_l0_73/params.npz
2025-11-20 05:03:04,196 [INFO] [sae_analyzer] load_gemma_scope_sae:62 - This may take a while if the model is not cached...
2025-11-20 05:03:04,465 [INFO] [sae_analyzer] load_gemma_scope_sae:70 - Download complete, loading from: /home/kriz_tahimic/.cache/huggingface/hub/models--google--gemma-scope-2b-pt-res/snapshots/fd571b47c1c64851e9b1989792367b9babb4af63/layer_19/width_16k/average_l0_73/params.npz
2025-11-20 05:03:05,912 [INFO] [sae_analyzer] load_gemma_scope_sae:87 - Loaded SAE with d_model=2304, d_sae=16384, sparsity=73
2025-11-20 05:03:05,912 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:125 - ✓ SAE loaded for Layer 19
2025-11-20 05:03:05,912 [INFO] [phase8_1_threshold_calculator.threshold_calculator] _load_dependencies:127 - Dependencies loaded successfully
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] __init__:67 - Initialization complete
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] run:328 - ============================================================
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] run:329 - Starting Phase 8.1: Percentile Threshold Calculator
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] run:330 - ============================================================
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:136 - ============================================================
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:137 - Calculating Percentile Thresholds
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:138 - ============================================================
2025-11-20 05:03:05,913 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:141 - Extracting L19-5441 activations from NPZ files...
2025-11-20 05:03:06,099 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:192 - ✓ Extracted 97 activations from 97 samples
2025-11-20 05:03:06,099 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:195 - Calculating activation statistics...
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:208 - Activation statistics:
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:209 -   Samples: 97
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:210 -   Mean: 19.2815
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:211 -   Std: 2.9438
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:212 -   Min: 0.0000
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:213 -   Max: 25.5891
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:214 -   Median: 19.2843
2025-11-20 05:03:06,100 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:217 - Calculating percentile thresholds...
2025-11-20 05:03:06,101 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:222 - 
Percentile Thresholds:
2025-11-20 05:03:06,101 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:223 - Percentile      Threshold    Steer %    Description
2025-11-20 05:03:06,101 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:224 - ------------------------------------------------------------
2025-11-20 05:03:06,101 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 5th            15.6970      95%        Steer top 95%
2025-11-20 05:03:06,101 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 10th            16.7571      90%        Steer top 90%
2025-11-20 05:03:06,102 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 15th            17.3179      85%        Steer top 85%
2025-11-20 05:03:06,102 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 20th            17.4725      80%        Steer top 80%
2025-11-20 05:03:06,102 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 25th            18.0585      75%        Steer top 75%
2025-11-20 05:03:06,103 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 30th            18.4047      70%        Steer top 70%
2025-11-20 05:03:06,103 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 35th            18.5298      65%        Steer top 65%
2025-11-20 05:03:06,103 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 40th            18.7596      60%        Steer top 60%
2025-11-20 05:03:06,104 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 45th            18.9986      55%        Steer top 55%
2025-11-20 05:03:06,104 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 50th            19.2843      50%        Steer top 50%
2025-11-20 05:03:06,104 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 55th            19.4310      45%        Steer top 45%
2025-11-20 05:03:06,105 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 60th            19.6462      40%        Steer top 40%
2025-11-20 05:03:06,105 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 65th            20.1995      35%        Steer top 35%
2025-11-20 05:03:06,106 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 70th            20.5801      30%        Steer top 30%
2025-11-20 05:03:06,106 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 75th            21.0463      25%        Steer top 25%
2025-11-20 05:03:06,106 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 80th            21.5797      20%        Steer top 20%
2025-11-20 05:03:06,107 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 85th            21.7197      15%        Steer top 15%
2025-11-20 05:03:06,107 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 90th            22.2769      10%        Steer top 10%
2025-11-20 05:03:06,107 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:237 - 95th            23.0295      5%        Steer top 5%
2025-11-20 05:03:06,108 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:266 - 
============================================================
2025-11-20 05:03:06,108 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:267 - Threshold Calculation Complete
2025-11-20 05:03:06,108 [INFO] [phase8_1_threshold_calculator.threshold_calculator] calculate_thresholds:268 - ============================================================
2025-11-20 05:03:06,108 [INFO] [phase8_1_threshold_calculator.threshold_calculator] save_results:274 - Saving results...
2025-11-20 05:03:06,109 [INFO] [phase8_1_threshold_calculator.threshold_calculator] save_results:279 - ✓ Saved thresholds to percentile_thresholds.json
2025-11-20 05:03:06,109 [INFO] [phase8_1_threshold_calculator.threshold_calculator] save_results:322 - ✓ Saved summary to threshold_summary.txt
2025-11-20 05:03:06,109 [INFO] [phase8_1_threshold_calculator.threshold_calculator] save_results:324 - 
Results saved to: data/phase8_1
2025-11-20 05:03:06,110 [INFO] [phase8_1_threshold_calculator.threshold_calculator] run:335 - 
✅ Phase 8.1 completed successfully
2025-11-20 05:03:06,110 [INFO] [phase8_1_threshold_calculator.runner] run_phase_8_1:29 - Phase 8.1 completed successfully
2025-11-20 05:03:06,110 [INFO] [main] run_phase8_1:689 - 
✅ Phase 8.1 completed successfully
